<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm"

const supabase = createClient(
  "https://mcofbchorvsseikgccek.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1jb2ZiY2hvcnZzc2Vpa2djY2VrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA4NDg2NDksImV4cCI6MjA4NjQyNDY0OX0.aUzfF3LEDqTXOs3hozzWqP-3h1atbAwwFX-A32RExig"
)

let currentUser = null
let activeTab = "friends"
let messageChannel = null

// ---------------- AUTH ----------------

window.login = async () => {
  const { data, error } = await supabase.auth.signInWithPassword({
    email: emailInput.value.trim(),
    password: passwordInput.value.trim()
  })
  if (error) return alert(error.message)

  currentUser = data.user
  showApp()
}

window.signup = async () => {
  const email = emailInput.value.trim()
  const password = passwordInput.value.trim()
  const username = usernameInput.value.trim()

  if (!username) return alert("Username required")

  const { data, error } = await supabase.auth.signUp({ email, password })
  if (error) return alert(error.message)

  await supabase.from("profiles").upsert({
    id: data.user.id,
    email,
    username
  })

  alert("Account created.")
}

window.logout = async () => {
  if (messageChannel) supabase.removeChannel(messageChannel)
  await supabase.auth.signOut()
  location.reload()
}

async function checkSession() {
  const { data } = await supabase.auth.getSession()
  if (data?.session) {
    currentUser = data.session.user
    showApp()
  } else {
    showLogin()
  }
}

function showLogin() {
  loginScreen.style.display = "flex"
  appScreen.style.display = "none"
}

function showApp() {
  loginScreen.style.display = "none"
  appScreen.style.display = "flex"
  loadTab()
}

// ---------------- TABS ----------------

window.switchTab = (tab) => {
  activeTab = tab
  loadTab()
}

async function loadTab() {
  if (activeTab === "friends") loadFriends()
  if (activeTab === "requests") loadRequests()
  if (activeTab === "dms") loadDMList()
}

// ---------------- REALTIME ----------------

function subscribeToMessages(conversationId) {

  if (messageChannel) {
    supabase.removeChannel(messageChannel)
  }

  messageChannel = supabase
    .channel("messages-" + conversationId)
    .on(
      "postgres_changes",
      {
        event: "INSERT",
        schema: "public",
        table: "messages",
        filter: `conversation_id=eq.${conversationId}`
      },
      () => {
        loadMessages(conversationId)
      }
    )
    .subscribe()
}

// ---------------- OPEN DM ----------------

window.openDM = async (conversationId) => {

  content.innerHTML = `
    <div class="chatContainer">
      <div id="messages" class="messages"></div>

      <div class="chatBottom">
        <button onclick="addToConversation('${conversationId}')">+</button>
        <input id="messageInput" placeholder="Type message...">
        <button onclick="sendMessage('${conversationId}')">Send</button>
      </div>
    </div>
  `

  setupEnter(conversationId)
  loadMessages(conversationId)
  subscribeToMessages(conversationId)
}

function setupEnter(conversationId) {
  const input = document.getElementById("messageInput")
  input.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      e.preventDefault()
      sendMessage(conversationId)
    }
  })
}

// ---------------- LOAD MESSAGES ----------------

async function loadMessages(conversationId) {

  const { data } = await supabase
    .from("messages")
    .select("*")
    .eq("conversation_id", conversationId)
    .order("created_at", { ascending: true })

  const messagesDiv = document.getElementById("messages")
  messagesDiv.innerHTML = ""

  for (let m of data || []) {
    const { data: profile } = await supabase
      .from("profiles")
      .select("username")
      .eq("id", m.sender_id)
      .single()

    messagesDiv.innerHTML += `
      <div><strong>${profile?.username || "Unknown"}:</strong> ${m.content}</div>
    `
  }

  messagesDiv.scrollTop = messagesDiv.scrollHeight
}

// ---------------- SEND ----------------

window.sendMessage = async (conversationId) => {
  const input = document.getElementById("messageInput")
  const text = input.value.trim()
  if (!text) return

  const { error } = await supabase.from("messages").insert({
    conversation_id: conversationId,
    sender_id: currentUser.id,
    content: text
  })

  if (error) {
    console.error(error)
    alert("Message failed to send.")
    return
  }

  input.value = ""
}

checkSession()
</script>
