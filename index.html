<!DOCTYPE html>
<html>
<head>
  <title>Discord Clone</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: Arial;
      background: #36393f;
      color: white;
      padding: 20px;
    }
    input, button {
      padding: 8px;
      margin: 5px;
    }
    #app { display: none; }
  </style>
</head>
<body>

<h2>Auth</h2>
<input id="email" placeholder="Email">
<input id="password" type="password" placeholder="Password">
<button onclick="signUp()">Sign Up</button>
<button onclick="login()">Login</button>

<div id="app">
  <h3>You are logged in</h3>
  <button onclick="logout()">Logout</button>

  <h3>Add Friend</h3>
  <input id="friendEmail" placeholder="Friend Email">
  <button onclick="addFriend()">Add Friend</button>

  <h3>Your Friends</h3>
  <div id="friendsList"></div>
</div>

<script>
const supabaseUrl = "https://mcofbchorvsseikgccek.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1jb2ZiY2hvcnZzc2Vpa2djY2VrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA4NDg2NDksImV4cCI6MjA4NjQyNDY0OX0.aUzfF3LEDqTXOs3hozzWqP-3h1atbAwwFX-A32RExig";
const supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);

async function signUp() {
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;

  const { data, error } = await supabaseClient.auth.signUp({
    email,
    password
  });

  if (error) {
    alert(error.message);
    return;
  }

  const { data: userData } = await supabaseClient.auth.getUser();

  if (userData?.user) {
    await supabaseClient.from("profiles").insert([
      {
        id: userData.user.id,
        email: userData.user.email
      }
    ]);
  }

  alert("Signup successful. You can login.");
}

async function login() {
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;

  const { error } = await supabaseClient.auth.signInWithPassword({
    email,
    password
  });

  if (error) {
    alert(error.message);
    return;
  }

  loadApp();
}

async function logout() {
  await supabaseClient.auth.signOut();
  document.getElementById("app").style.display = "none";
}

async function loadApp() {
  document.getElementById("app").style.display = "block";
  loadFriends();
}

async function addFriend() {
  const friendEmail = document.getElementById("friendEmail").value;

  const { data: friendProfile } = await supabaseClient
    .from("profiles")
    .select("*")
    .eq("email", friendEmail)
    .single();

  if (!friendProfile) {
    alert("Email user not found");
    return;
  }

  const { data: userData } = await supabaseClient.auth.getUser();

  await supabaseClient.from("friends").insert([
    {
      user_id: userData.user.id,
      friend_id: friendProfile.id
    }
  ]);

  alert("Friend added");
  loadFriends();
}

async function loadFriends() {
  const { data: userData } = await supabaseClient.auth.getUser();

  const { data: friends } = await supabaseClient
    .from("friends")
    .select("friend_id")
    .eq("user_id", userData.user.id);

  const list = document.getElementById("friendsList");
  list.innerHTML = "";

  for (let f of friends || []) {
    const { data: profile } = await supabaseClient
      .from("profiles")
      .select("email")
      .eq("id", f.friend_id)
      .single();

    if (profile) {
      const div = document.createElement("div");
      div.innerText = profile.email;
      list.appendChild(div);
    }
  }
}

supabaseClient.auth.onAuthStateChange((event, session) => {
  if (session) {
    loadApp();
  }
});
</script>

</body>
</html>
