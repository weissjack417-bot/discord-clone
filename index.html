<!DOCTYPE html>
<html>
<head>
  <title>Chat App</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    body {
      margin: 0;
      font-family: Arial;
      display: flex;
      height: 100vh;
      background: #1e1f22;
      color: white;
    }

    #sidebar {
      width: 280px;
      background: #2b2d31;
      padding: 15px;
      display: flex;
      flex-direction: column;
      gap: 20px;
      overflow-y: auto;
    }

    h3 {
      margin: 10px 0 5px 0;
      font-size: 14px;
      color: #aaa;
    }

    .list-item {
      padding: 8px;
      border-radius: 6px;
      cursor: pointer;
      background: #383a40;
      margin-bottom: 5px;
    }

    .list-item:hover {
      background: #4e5058;
    }

    button {
      padding: 6px 10px;
      margin-top: 5px;
      cursor: pointer;
    }

    #main {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    #chatHeader {
      padding: 15px;
      background: #313338;
      border-bottom: 1px solid #444;
    }

    #messages {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .message {
      background: #383a40;
      padding: 8px 12px;
      border-radius: 8px;
      max-width: 60%;
    }

    #inputArea {
      padding: 15px;
      background: #2b2d31;
      display: flex;
      gap: 10px;
    }

    #messageInput {
      flex: 1;
      padding: 10px;
    }
  </style>
</head>
<body>

<div id="sidebar">
  <h3>Friends</h3>
  <div id="friendsList"></div>

  <h3>Requests</h3>
  <div id="requestsList"></div>

  <h3>Direct Messages</h3>
  <button onclick="createGroupDM()">+ New DM</button>
  <div id="dmList"></div>

  <button onclick="logout()">Logout</button>
</div>

<div id="main">
  <div id="chatHeader">Select a conversation</div>
  <div id="messages"></div>
  <div id="inputArea">
    <input id="messageInput" placeholder="Type a message..." />
    <button onclick="sendMessage()">Send</button>
  </div>
</div>

<script>
const supabase = supabase.createClient(
  "https://mcofbchorvsseikgccek.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1jb2ZiY2hvcnZzc2Vpa2djY2VrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA4NDg2NDksImV4cCI6MjA4NjQyNDY0OX0.aUzfF3LEDqTXOs3hozzWqP-3h1atbAwwFX-A32RExig"
);

let currentUser = null;
let currentConversation = null;
let realtimeChannel = null;

init();

async function init() {
  const { data } = await supabase.auth.getUser();
  currentUser = data.user;
  if (!currentUser) return;

  loadFriends();
  loadRequests();
  loadDMs();
}

async function loadFriends() {
  const { data } = await supabase
    .from("friends")
    .select("*, profiles:profiles!friends_addressee_id_fkey(username)")
    .eq("requester_id", currentUser.id)
    .eq("status", "accepted");

  const list = document.getElementById("friendsList");
  list.innerHTML = "";

  data?.forEach(friend => {
    const div = document.createElement("div");
    div.className = "list-item";
    div.innerText = friend.profiles.username;
    div.onclick = () => startDM(friend.addressee_id);
    list.appendChild(div);
  });
}

async function loadRequests() {
  const { data } = await supabase
    .from("friends")
    .select("*, profiles:profiles!friends_requester_id_fkey(username)")
    .eq("addressee_id", currentUser.id)
    .eq("status", "pending");

  const list = document.getElementById("requestsList");
  list.innerHTML = "";

  data?.forEach(req => {
    const div = document.createElement("div");
    div.className = "list-item";
    div.innerHTML = `
      ${req.profiles.username}
      <button onclick="acceptRequest('${req.id}')">Accept</button>
    `;
    list.appendChild(div);
  });
}

async function acceptRequest(id) {
  await supabase.from("friends")
    .update({ status: "accepted" })
    .eq("id", id);
  loadFriends();
  loadRequests();
}

async function startDM(userId) {
  let { data: existing } = await supabase
    .from("conversation_participants")
    .select("conversation_id")
    .eq("user_id", currentUser.id);

  if (!existing) return;

  let conversationId = null;

  for (let convo of existing) {
    let { data: participants } = await supabase
      .from("conversation_participants")
      .select("user_id")
      .eq("conversation_id", convo.conversation_id);

    if (!participants) continue;

    const ids = participants.map(p => p.user_id);
    if (ids.length === 2 && ids.includes(userId)) {
      conversationId = convo.conversation_id;
      break;
    }
  }

  if (!conversationId) {
    const { data: newConvo } = await supabase
      .from("conversations")
      .insert({})
      .select()
      .single();

    conversationId = newConvo.id;

    await supabase.from("conversation_participants").insert([
      { conversation_id: conversationId, user_id: currentUser.id },
      { conversation_id: conversationId, user_id: userId }
    ]);
  }

  openConversation(conversationId);
}

async function createGroupDM() {
  const usernames = prompt("Enter usernames separated by commas:");
  if (!usernames) return;

  const names = usernames.split(",").map(n => n.trim());

  const { data: users } = await supabase
    .from("profiles")
    .select("id")
    .in("username", names);

  if (!users) return;

  const { data: convo } = await supabase
    .from("conversations")
    .insert({})
    .select()
    .single();

  const participants = users.map(u => ({
    conversation_id: convo.id,
    user_id: u.id
  }));

  participants.push({
    conversation_id: convo.id,
    user_id: currentUser.id
  });

  await supabase.from("conversation_participants").insert(participants);

  loadDMs();
}

async function loadDMs() {
  const { data } = await supabase
    .from("conversation_participants")
    .select("conversation_id")
    .eq("user_id", currentUser.id);

  const list = document.getElementById("dmList");
  list.innerHTML = "";

  data?.forEach(convo => {
    const div = document.createElement("div");
    div.className = "list-item";
    div.innerText = convo.conversation_id;
    div.onclick = () => openConversation(convo.conversation_id);
    list.appendChild(div);
  });
}

async function openConversation(id) {
  currentConversation = id;
  document.getElementById("messages").innerHTML = "";

  if (realtimeChannel) {
    supabase.removeChannel(realtimeChannel);
  }

  loadMessages();

  realtimeChannel = supabase
    .channel("messages")
    .on("postgres_changes",
      { event: "INSERT", schema: "public", table: "messages" },
      payload => {
        if (payload.new.conversation_id === currentConversation) {
          appendMessage(payload.new);
        }
      })
    .subscribe();
}

async function loadMessages() {
  const { data } = await supabase
    .from("messages")
    .select("*")
    .eq("conversation_id", currentConversation)
    .order("created_at");

  const container = document.getElementById("messages");
  container.innerHTML = "";

  data?.forEach(msg => appendMessage(msg));
}

function appendMessage(msg) {
  const div = document.createElement("div");
  div.className = "message";
  div.innerText = msg.content;
  document.getElementById("messages").appendChild(div);
}

async function sendMessage() {
  const input = document.getElementById("messageInput");
  const content = input.value.trim();
  if (!content || !currentConversation) return;

  await supabase.from("messages").insert({
    content,
    sender_id: currentUser.id,
    conversation_id: currentConversation
  });

  input.value = "";
}

document.getElementById("messageInput")
  .addEventListener("keydown", e => {
    if (e.key === "Enter") sendMessage();
  });

async function logout() {
  await supabase.auth.signOut();
  location.reload();
}
</script>

</body>
</html>
