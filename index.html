<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Discord Clone</title>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm"

const supabase = createClient(
  "https://mcofbchorvsseikgccek.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1jb2ZiY2hvcnZzc2Vpa2djY2VrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA4NDg2NDksImV4cCI6MjA4NjQyNDY0OX0.aUzfF3LEDqTXOs3hozzWqP-3h1atbAwwFX-A32RExig" // replace with your actual anon key
)

let currentUser = null
let activeTab = "friends"

// ---------------- LOGIN ----------------
window.login = async () => {
  const email = document.getElementById("email").value
  const password = document.getElementById("password").value

  const { data, error } = await supabase.auth.signInWithPassword({ email, password })
  if (error) return alert(error.message)

  currentUser = data.user
  showApp()
}

// ---------------- SIGNUP ----------------
window.signup = async () => {
  const email = document.getElementById("email").value
  const password = document.getElementById("password").value
  const username = document.getElementById("username").value.trim()

  if (!username) return alert("Username is required.")

  // Check if username already exists
  const { data: existing } = await supabase
    .from("profiles")
    .select("id")
    .eq("username", username)
    .single()

  if (existing) return alert("Username already taken!")

  // Sign up user
  const { data: authData, error: authError } = await supabase.auth.signUp({ email, password })
  if (authError) return alert(authError.message)

  // Insert profile with username
  const { error: profileError } = await supabase
    .from("profiles")
    .insert({ id: authData.user.id, email, username })
  if (profileError) return alert(profileError.message)

  alert("Account created! Check your email to confirm.")
}

// ---------------- LOGOUT ----------------
window.logout = async () => {
  await supabase.auth.signOut()
  localStorage.clear()
  location.reload()
}

// ---------------- SHOW SCREENS ----------------
function showLogin() {
  document.getElementById("loginScreen").style.display = "flex"
  document.getElementById("appScreen").style.display = "none"
}

function showApp() {
  document.getElementById("loginScreen").style.display = "none"
  document.getElementById("appScreen").style.display = "flex"
  loadTab()
}

// ---------------- CHECK SESSION ----------------
async function checkSession() {
  const { data } = await supabase.auth.getSession()
  if (data.session) {
    currentUser = data.session.user
    showApp()
  } else {
    showLogin()
  }
}

// ---------------- TAB SWITCH ----------------
window.switchTab = (tab) => {
  activeTab = tab
  loadTab()
}

// ---------------- LOAD FRIENDS ----------------
async function loadFriends() {
  const container = document.getElementById("content")
  container.innerHTML = "Loading friends..."

  // Step 1: get all accepted friendships for current user
  const { data: friendsData, error } = await supabase
    .from("friends")
    .select("id, requester_id, addressee_id")
    .or(`requester_id.eq.${currentUser.id},addressee_id.eq.${currentUser.id}`)
    .eq("status", "accepted")

  if (!friendsData || friendsData.length === 0) {
    container.innerHTML = "<p>No friends yet.</p>"
    return
  }

  // Step 2: get usernames of all friends
  const friendIds = friendsData.map(f => (f.requester_id === currentUser.id ? f.addressee_id : f.requester_id))
  const { data: profiles } = await supabase
    .from("profiles")
    .select("id, username, email")
    .in("id", friendIds)

  const usernameMap = {}
  profiles.forEach(p => usernameMap[p.id] = p.username || p.email)

  // Step 3: render friends
  container.innerHTML = ""
  friendsData.forEach(f => {
    const friendId = f.requester_id === currentUser.id ? f.addressee_id : f.requester_id
    const displayName = usernameMap[friendId] || "Unknown"
    container.innerHTML += `<div class="card">${displayName}</div>`
  })
}

// ---------------- LOAD REQUESTS ----------------
async function loadRequests() {
  const container = document.getElementById("content")
  container.innerHTML = "Loading requests..."

  // Step 1: get pending requests where currentUser is addressee
  const { data: requests, error } = await supabase
    .from("friends")
    .select("id, requester_id")
    .eq("addressee_id", currentUser.id)
    .eq("status", "pending")

  if (!requests || requests.length === 0) {
    container.innerHTML = "<p>No pending requests.</p>"
    return
  }

  // Step 2: get usernames of requesters
  const requesterIds = requests.map(r => r.requester_id)
  const { data: profiles } = await supabase
    .from("profiles")
    .select("id, username, email")
    .in("id", requesterIds)

  const usernameMap = {}
  profiles.forEach(p => usernameMap[p.id] = p.username || p.email)

  // Step 3: render requests
  container.innerHTML = ""
  requests.forEach(r => {
    const displayName = usernameMap[r.requester_id] || "Unknown"
    container.innerHTML += `
      <div class="card">
        ${displayName}
        <button onclick="acceptRequest('${r.id}')">Accept</button>
      </div>`
  })
}

// ---------------- ACCEPT REQUEST ----------------
window.acceptRequest = async (id) => {
  await supabase.from("friends").update({ status: "accepted" }).eq("id", id)
  loadRequests()
  loadFriends()
}

// ---------------- ADD FRIEND ----------------
window.addFriend = async () => {
  const email = prompt("Enter friend's email:")
  if (!email) return

  const { data: profile, error } = await supabase
    .from("profiles")
    .select("id, username, email")
    .eq("email", email)
    .single()

  if (error || !profile) return alert("User not found")

  await supabase.from("friends").insert({
    requester_id: currentUser.id,
    addressee_id: profile.id,
    status: "pending"
  })

  alert("Friend request sent.")
}

// ---------------- DMS PLACEHOLDER ----------------
function loadDMs() {
  document.getElementById("content").innerHTML =
    "<p>DM system coming next.</p>"
}

// ---------------- INITIAL CHECK ----------------
checkSession()
</script>

<style>
body {
  margin:0;
  font-family:Arial;
  background:#313338;
  color:white;
}

button {
  background:#5865F2;
  border:none;
  padding:8px 12px;
  border-radius:5px;
  color:white;
  cursor:pointer;
  margin-top:5px;
}

button:hover { opacity:0.8 }

#loginScreen {
  display:none;
  height:100vh;
  justify-content:center;
  align-items:center;
}

.loginBox {
  background:#1e1f22;
  padding:30px;
  border-radius:8px;
  display:flex;
  flex-direction:column;
  gap:10px;
  width:300px;
}

input {
  padding:8px;
  border-radius:4px;
  border:none;
}

#appScreen {
  display:none;
  height:100vh;
}

.sidebar {
  width:220px;
  background:#1e1f22;
  padding:15px;
}

.sidebar button {
  width:100%;
  margin-bottom:10px;
}

.main {
  flex:1;
  padding:20px;
}

.card {
  background:#2b2d31;
  padding:10px;
  border-radius:6px;
  margin-bottom:10px;
}
</style>
</head>

<body>

<div id="loginScreen">
  <div class="loginBox">
    <h2>Login / Create Account</h2>
    <input id="email" placeholder="Email">
    <input id="username" placeholder="Username (for new accounts)">
    <input id="password" type="password" placeholder="Password">
    <button onclick="login()">Login</button>
    <button onclick="signup()">Sign Up</button>
  </div>
</div>

<div id="appScreen" style="display:flex;">
  <div class="sidebar">
    <button onclick="switchTab('friends')">Friends</button>
    <button onclick="switchTab('requests')">Requests</button>
    <button onclick="switchTab('dms')">DMs</button>
    <button onclick="addFriend()">+ Add Friend</button>
    <button onclick="logout()">Logout</button>
  </div>
  <div class="main">
    <div id="content"></div>
  </div>
</div>

</body>
</html>
