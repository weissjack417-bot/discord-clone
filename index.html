<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Chat App</title>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm"

const supabase = createClient(
  "https://mcofbchorvsseikgccek.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1jb2ZiY2hvcnZzc2Vpa2djY2VrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA4NDg2NDksImV4cCI6MjA4NjQyNDY0OX0.aUzfF3LEDqTXOs3hozzWqP-3h1atbAwwFX-A32RExig"
)

let currentUser = null
let currentConversationId = null
let messageChannel = null

// ---------------- AUTH ----------------

async function checkSession() {
  const { data } = await supabase.auth.getSession()
  if (data?.session) {
    currentUser = data.session.user
    showApp()
  } else {
    showLogin()
  }
}

window.login = async () => {
  const { data, error } = await supabase.auth.signInWithPassword({
    email: emailInput.value.trim(),
    password: passwordInput.value.trim()
  })
  if (error) return alert(error.message)
  currentUser = data.user
  showApp()
}

window.signup = async () => {
  const email = emailInput.value.trim()
  const password = passwordInput.value.trim()
  const username = usernameInput.value.trim()
  if (!username) return alert("Username required")

  const { data, error } = await supabase.auth.signUp({ email, password })
  if (error) return alert(error.message)

  await supabase.from("profiles").upsert({
    id: data.user.id,
    email,
    username
  })

  alert("Account created.")
}

window.logout = async () => {
  if (messageChannel) supabase.removeChannel(messageChannel)
  await supabase.auth.signOut()
  location.reload()
}

function showLogin() {
  loginScreen.style.display = "flex"
  appScreen.style.display = "none"
}

function showApp() {
  loginScreen.style.display = "none"
  appScreen.style.display = "flex"
  loadConversations()
}

// ---------------- LOAD SIDEBAR DMs ----------------

async function loadConversations() {

  dmList.innerHTML = ""

  const { data } = await supabase
    .from("conversation_participants")
    .select("conversation_id")
    .eq("user_id", currentUser.id)

  if (!data?.length) {
    dmList.innerHTML = "<p style='padding:10px;'>No DMs</p>"
    return
  }

  for (let convo of data) {

    const { data: participants } = await supabase
      .from("conversation_participants")
      .select("user_id")
      .eq("conversation_id", convo.conversation_id)

    const names = []

    for (let p of participants || []) {
      if (p.user_id === currentUser.id) continue

      const { data: profile } = await supabase
        .from("profiles")
        .select("username")
        .eq("id", p.user_id)
        .single()

      if (profile?.username) names.push(profile.username)
    }

    const div = document.createElement("div")
    div.className = "dmItem"
    div.textContent = names.join(", ") || "Conversation"
    div.onclick = () => openDM(convo.conversation_id)
    dmList.appendChild(div)
  }
}

// ---------------- OPEN DM ----------------

async function openDM(conversationId) {

  currentConversationId = conversationId

  chatArea.innerHTML = `
    <div class="chatContainer">
      <div id="messages" class="messages"></div>
      <div class="chatBottom">
        <input id="messageInput" placeholder="Type message...">
        <button id="sendBtn">Send</button>
      </div>
    </div>
  `

  const input = document.getElementById("messageInput")
  const button = document.getElementById("sendBtn")

  button.addEventListener("click", sendMessage)

  input.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      e.preventDefault()
      sendMessage()
    }
  })

  await loadMessages()
  subscribeToMessages()
}

// ---------------- LOAD MESSAGES ----------------

async function loadMessages() {

  const { data } = await supabase
    .from("messages")
    .select("*")
    .eq("conversation_id", currentConversationId)
    .order("created_at", { ascending: true })

  const messagesDiv = document.getElementById("messages")
  messagesDiv.innerHTML = ""

  for (let m of data || []) {
    appendMessage(m, false)
  }

  messagesDiv.scrollTop = messagesDiv.scrollHeight
}

// ---------------- APPEND MESSAGE ----------------

async function appendMessage(message, scroll = true) {

  const messagesDiv = document.getElementById("messages")
  if (!messagesDiv) return

  const { data: profile } = await supabase
    .from("profiles")
    .select("username")
    .eq("id", message.sender_id)
    .single()

  const div = document.createElement("div")
  div.className = "message"
  div.innerHTML = `<strong>${profile?.username || "Unknown"}:</strong> ${message.content}`
  messagesDiv.appendChild(div)

  if (scroll) messagesDiv.scrollTop = messagesDiv.scrollHeight
}

// ---------------- SEND ----------------

async function sendMessage() {

  if (!currentConversationId) return

  const input = document.getElementById("messageInput")
  const text = input.value.trim()
  if (!text) return

  const { data, error } = await supabase
    .from("messages")
    .insert({
      conversation_id: currentConversationId,
      sender_id: currentUser.id,
      content: text
    })
    .select()
    .single()

  if (error) {
    console.error(error)
    alert("Failed to send.")
    return
  }

  appendMessage(data)
  input.value = ""
}

// ---------------- REALTIME ----------------

function subscribeToMessages() {

  if (messageChannel) {
    supabase.removeChannel(messageChannel)
  }

  messageChannel = supabase
    .channel("messages-" + currentConversationId)
    .on(
      "postgres_changes",
      {
        event: "INSERT",
        schema: "public",
        table: "messages",
        filter: `conversation_id=eq.${currentConversationId}`
      },
      (payload) => {
        if (payload.new.sender_id === currentUser.id) return
        appendMessage(payload.new)
      }
    )
    .subscribe()
}

checkSession()
</script>

<style>
body { margin:0; font-family:Arial; background:#313338; color:white; }

#loginScreen { display:none; height:100vh; justify-content:center; align-items:center; }
.loginBox { background:#1e1f22; padding:30px; border-radius:8px; display:flex; flex-direction:column; gap:10px; width:300px; }

input { padding:8px; border-radius:4px; border:none; }

button {
  background:#5865F2;
  border:none;
  padding:8px 12px;
  border-radius:5px;
  color:white;
  cursor:pointer;
}

button:hover { opacity:0.85 }

#appScreen { display:none; height:100vh; display:flex; }

.sidebar {
  width:240px;
  background:#1e1f22;
  display:flex;
  flex-direction:column;
}

.sidebarHeader {
  padding:15px;
  font-weight:bold;
  border-bottom:1px solid #2b2d31;
}

.dmList {
  flex:1;
  overflow-y:auto;
}

.dmItem {
  padding:12px;
  cursor:pointer;
}

.dmItem:hover {
  background:#2b2d31;
}

.chatArea {
  flex:1;
  display:flex;
  flex-direction:column;
  padding:15px;
}

.chatContainer {
  display:flex;
  flex-direction:column;
  height:100%;
}

.messages {
  flex:1;
  overflow-y:auto;
  margin-bottom:10px;
}

.message {
  margin-bottom:6px;
}

.chatBottom {
  display:flex;
  gap:10px;
}

.chatBottom input {
  flex:1;
}
</style>
</head>

<body>

<div id="loginScreen">
  <div class="loginBox">
    <h2>Login / Sign Up</h2>
    <input id="emailInput" placeholder="Email">
    <input id="passwordInput" type="password" placeholder="Password">
    <input id="usernameInput" placeholder="Username (signup only)">
    <button onclick="login()">Login</button>
    <button onclick="signup()">Sign Up</button>
  </div>
</div>

<div id="appScreen">

  <div class="sidebar">
    <div class="sidebarHeader">Direct Messages</div>
    <div id="dmList" class="dmList"></div>
    <button style="margin:10px;" onclick="logout()">Logout</button>
  </div>

  <div id="chatArea" class="chatArea">
    <h3>Select a DM</h3>
  </div>

</div>

</body>
</html>
