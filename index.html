<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Discord Clone</title>

<style>
* { box-sizing: border-box; }

body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: #313338;
  color: white;
  height: 100vh;
}

/* LOGIN */
#login-screen {
  display: flex;
  height: 100vh;
  justify-content: center;
  align-items: center;
}

.login-box {
  background: #1e1f22;
  padding: 30px;
  border-radius: 8px;
  width: 300px;
}

.login-box input {
  width: 100%;
  padding: 10px;
  margin-bottom: 10px;
  border: none;
  border-radius: 5px;
}

.login-box button {
  width: 100%;
  padding: 10px;
  background: #5865f2;
  border: none;
  color: white;
  border-radius: 5px;
  cursor: pointer;
}

/* APP */
#app-screen {
  display: none;
  height: 100vh;
}

.sidebar {
  width: 240px;
  background: #1e1f22;
  padding: 10px;
}

.sidebar h3 {
  margin-top: 0;
}

.friend {
  padding: 8px;
  background: #2b2d31;
  border-radius: 5px;
  margin-bottom: 5px;
}

.main {
  flex: 1;
  background: #313338;
  display: flex;
  flex-direction: column;
}

.topbar {
  background: #1e1f22;
  padding: 10px;
  display: flex;
  justify-content: space-between;
}

.content {
  flex: 1;
  padding: 10px;
}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="login-screen">
  <div class="login-box">
    <h2>Login</h2>
    <input id="email" placeholder="Email">
    <input id="password" type="password" placeholder="Password">
    <button onclick="login()">Login</button>
  </div>
</div>

<!-- APP -->
<div id="app-screen">
  <div class="sidebar">
    <h3>Friends</h3>
    <div id="friends-list">Loading...</div>
  </div>

  <div class="main">
    <div class="topbar">
      <div>Home</div>
      <button onclick="logout()">Logout</button>
    </div>
    <div class="content">
      Select a friend to DM (next step)
    </div>
  </div>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm"

const SUPABASE_URL = "https://mcofbchorvsseikgccek.supabase.co"
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1jb2ZiY2hvcnZzc2Vpa2djY2VrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA4NDg2NDksImV4cCI6MjA4NjQyNDY0OX0.aUzfF3LEDqTXOs3hozzWqP-3h1atbAwwFX-A32RExig"

const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

let currentUser = null

const loginScreen = document.getElementById("login-screen")
const appScreen = document.getElementById("app-screen")
const friendsList = document.getElementById("friends-list")

// -------------------- AUTH CHECK --------------------
async function init() {
  const { data: { session } } = await supabase.auth.getSession()

  if (session) {
    currentUser = session.user
    showApp()
  } else {
    showLogin()
  }
}

function showLogin() {
  loginScreen.style.display = "flex"
  appScreen.style.display = "none"
}

function showApp() {
  loginScreen.style.display = "none"
  appScreen.style.display = "flex"
  loadFriends()
}

// -------------------- LOGIN --------------------
window.login = async function () {
  const email = document.getElementById("email").value
  const password = document.getElementById("password").value

  const { data, error } = await supabase.auth.signInWithPassword({
    email,
    password
  })

  if (error) {
    alert(error.message)
    return
  }

  currentUser = data.user
  showApp()
}

// -------------------- LOGOUT --------------------
window.logout = async function () {
  await supabase.auth.signOut()
  showLogin()
}

// -------------------- FRIENDS --------------------
async function loadFriends() {
  friendsList.innerHTML = "Loading..."

  const { data, error } = await supabase
    .from("friends")
    .select("*")
    .or(
      `requester_id.eq.${currentUser.id},addressee_id.eq.${currentUser.id}`
    )
    .eq("status", "accepted")

  if (error) {
    friendsList.innerHTML = "Error loading friends"
    console.error(error)
    return
  }

  if (!data.length) {
    friendsList.innerHTML = "No friends yet"
    return
  }

  friendsList.innerHTML = ""

  data.forEach(row => {
    const friendId =
      row.requester_id === currentUser.id
        ? row.addressee_id
        : row.requester_id

    const div = document.createElement("div")
    div.className = "friend"
    div.textContent = friendId
    friendsList.appendChild(div)
  })
}

init()
</script>

</body>
</html>
