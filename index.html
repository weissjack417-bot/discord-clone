<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Chat App</title>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm"

const supabase = createClient(
  "https://mcofbchorvsseikgccek.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1jb2ZiY2hvcnZzc2Vpa2djY2VrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA4NDg2NDksImV4cCI6MjA4NjQyNDY0OX0.aUzfF3LEDqTXOs3hozzWqP-3h1atbAwwFX-A32RExig"
)

let currentUser = null
let activeTab = "friends"
let messageSubscription = null

// ---------------- AUTH ----------------

window.login = async () => {
  const email = emailInput.value.trim()
  const password = passwordInput.value.trim()

  const { data, error } = await supabase.auth.signInWithPassword({ email, password })
  if (error) return alert(error.message)

  currentUser = data.user
  showApp()
}

window.signup = async () => {
  const email = emailInput.value.trim()
  const password = passwordInput.value.trim()
  const username = usernameInput.value.trim()

  if (!username) return alert("Username required")

  const { data, error } = await supabase.auth.signUp({ email, password })
  if (error) return alert(error.message)
  if (!data.user) return alert("Signup failed")

  const { error: profileError } = await supabase
    .from("profiles")
    .upsert({
      id: data.user.id,
      email: email,
      username: username
    })

  if (profileError) return alert(profileError.message)

  alert("Account created. You can now log in.")
}

window.logout = async () => {
  if (messageSubscription) supabase.removeChannel(messageSubscription)
  await supabase.auth.signOut()
  location.reload()
}

async function checkSession() {
  const { data } = await supabase.auth.getSession()
  if (data?.session) {
    currentUser = data.session.user
    showApp()
  } else {
    showLogin()
  }
}

function showLogin() {
  loginScreen.style.display = "flex"
  appScreen.style.display = "none"
}

function showApp() {
  loginScreen.style.display = "none"
  appScreen.style.display = "flex"
  loadTab()
}

// ---------------- TABS ----------------

window.switchTab = (tab) => {
  activeTab = tab
  loadTab()
}

async function loadTab() {
  if (!currentUser) return
  if (activeTab === "friends") loadFriends()
  if (activeTab === "requests") loadRequests()
  if (activeTab === "dms") loadDMList()
}

// ---------------- FRIENDS ----------------

async function loadFriends() {
  content.innerHTML = "Loading..."

  const { data, error } = await supabase
    .from("friends")
    .select("*")
    .or(`requester_id.eq.${currentUser.id},addressee_id.eq.${currentUser.id}`)
    .eq("status", "accepted")

  if (error || !data || data.length === 0) {
    content.innerHTML = "<p>No friends yet.</p>"
    return
  }

  content.innerHTML = ""

  for (let f of data) {
    const friendId = f.requester_id === currentUser.id
      ? f.addressee_id
      : f.requester_id

    const { data: profile } = await supabase
      .from("profiles")
      .select("username")
      .eq("id", friendId)
      .single()

    content.innerHTML += `
      <div class="card" onclick="startDM('${friendId}')">
        ${profile?.username || "Unknown"}
      </div>`
  }
}

// ---------------- REQUESTS ----------------

async function loadRequests() {
  content.innerHTML = "Loading..."

  const { data } = await supabase
    .from("friends")
    .select("*")
    .eq("addressee_id", currentUser.id)
    .eq("status", "pending")

  if (!data || data.length === 0) {
    content.innerHTML = "<p>No pending requests.</p>"
    return
  }

  content.innerHTML = ""

  for (let r of data) {
    const { data: profile } = await supabase
      .from("profiles")
      .select("username")
      .eq("id", r.requester_id)
      .single()

    content.innerHTML += `
      <div class="card">
        ${profile?.username || "Unknown"}
        <button onclick="acceptRequest('${r.id}')">Accept</button>
      </div>`
  }
}

window.acceptRequest = async (id) => {
  await supabase.from("friends").update({ status: "accepted" }).eq("id", id)
  loadRequests()
}

// ---------------- ADD FRIEND ----------------

window.addFriend = async () => {
  const username = prompt("Enter username:")
  if (!username) return

  const { data: profile } = await supabase
    .from("profiles")
    .select("id")
    .eq("username", username)
    .single()

  if (!profile) return alert("User not found")
  if (profile.id === currentUser.id) return alert("You can't add yourself")

  await supabase.from("friends").insert({
    requester_id: currentUser.id,
    addressee_id: profile.id,
    status: "pending"
  })

  alert("Friend request sent.")
}

// ---------------- DMs ----------------

async function loadDMList() {
  content.innerHTML = "Loading conversations..."

  const { data } = await supabase
    .from("conversation_participants")
    .select("conversation_id")
    .eq("user_id", currentUser.id)

  if (!data || data.length === 0) {
    content.innerHTML = "<p>No conversations yet.</p>"
    return
  }

  content.innerHTML = ""

  for (let c of data) {

    if (!c.conversation_id) continue   // ðŸš¨ skip broken rows

    const { data: participants } = await supabase
      .from("conversation_participants")
      .select("user_id")
      .eq("conversation_id", c.conversation_id)

    if (!participants) continue

    const other = participants.find(p => p.user_id !== currentUser.id)
    if (!other) continue

    const { data: profile } = await supabase
      .from("profiles")
      .select("username")
      .eq("id", other.user_id)
      .single()

    content.innerHTML += `
      <div class="card" onclick="openDM('${c.conversation_id}')">
        ${profile?.username || "Unknown"}
      </div>`
  }
}

window.startDM = async (friendId) => {

  const { data: existing } = await supabase
    .from("conversation_participants")
    .select("conversation_id")
    .eq("user_id", currentUser.id)

  if (!existing) return

  for (let convo of existing) {

    if (!convo.conversation_id) continue

    const { data: participants } = await supabase
      .from("conversation_participants")
      .select("user_id")
      .eq("conversation_id", convo.conversation_id)

    if (!participants) continue

    if (participants.find(p => p.user_id === friendId)) {
      switchTab("dms")
      openDM(convo.conversation_id)
      return
    }
  }

  const { data: newConvo } = await supabase
    .from("conversations")
    .insert({})
    .select()
    .single()

  if (!newConvo) return alert("Could not create conversation.")

  await supabase.from("conversation_participants").insert([
    { conversation_id: newConvo.id, user_id: currentUser.id },
    { conversation_id: newConvo.id, user_id: friendId }
  ])

  switchTab("dms")
  openDM(newConvo.id)
}

window.openDM = async (conversationId) => {

  if (!conversationId) return

  if (messageSubscription) supabase.removeChannel(messageSubscription)

  content.innerHTML = `
    <div id="messages" style="height:300px; overflow-y:auto;"></div>
    <div style="margin-top:10px;">
      <input id="messageInput" placeholder="Type message..." style="width:70%;">
      <button onclick="sendMessage('${conversationId}')">Send</button>
    </div>
  `

  loadMessages(conversationId)
}

async function loadMessages(conversationId) {

  if (!conversationId) return

  const { data } = await supabase
    .from("messages")
    .select("*")
    .eq("conversation_id", conversationId)
    .order("created_at", { ascending: true })

  const messagesDiv = document.getElementById("messages")
  if (!messagesDiv) return

  messagesDiv.innerHTML = ""

  for (let m of data || []) {
    const { data: profile } = await supabase
      .from("profiles")
      .select("username")
      .eq("id", m.sender_id)
      .single()

    messagesDiv.innerHTML += `
      <div><strong>${profile?.username || "Unknown"}:</strong> ${m.content}</div>
    `
  }

  messagesDiv.scrollTop = messagesDiv.scrollHeight
}

window.sendMessage = async (conversationId) => {
  const input = document.getElementById("messageInput")
  if (!input || !input.value.trim()) return

  await supabase.from("messages").insert({
    conversation_id: conversationId,
    sender_id: currentUser.id,
    content: input.value.trim()
  })

  input.value = ""
  loadMessages(conversationId)
}

checkSession()
</script>

<style>
body { margin:0; font-family:Arial; background:#313338; color:white; }
button { background:#5865F2; border:none; padding:8px 12px; border-radius:5px; color:white; cursor:pointer; margin-top:5px; }
button:hover { opacity:0.85 }
#loginScreen { display:none; height:100vh; justify-content:center; align-items:center; }
.loginBox { background:#1e1f22; padding:30px; border-radius:8px; display:flex; flex-direction:column; gap:10px; width:300px; }
input { padding:8px; border-radius:4px; border:none; }
#appScreen { display:none; height:100vh; }
.sidebar { width:220px; background:#1e1f22; padding:15px; }
.sidebar button { width:100%; margin-bottom:10px; }
.main { flex:1; padding:20px; }
.card { background:#2b2d31; padding:10px; border-radius:6px; margin-bottom:10px; cursor:pointer; }
</style>
</head>

<body>

<div id="loginScreen">
  <div class="loginBox">
    <h2>Login / Sign Up</h2>
    <input id="emailInput" placeholder="Email">
    <input id="passwordInput" type="password" placeholder="Password">
    <input id="usernameInput" placeholder="Username (signup only)">
    <button onclick="login()">Login</button>
    <button onclick="signup()">Sign Up</button>
  </div>
</div>

<div id="appScreen" style="display:flex;">
  <div class="sidebar">
    <button onclick="switchTab('friends')">Friends</button>
    <button onclick="switchTab('requests')">Requests</button>
    <button onclick="switchTab('dms')">DMs</button>
    <button onclick="addFriend()">+ Add Friend</button>
    <button onclick="logout()">Logout</button>
  </div>
  <div class="main">
    <div id="content"></div>
  </div>
</div>

</body>
</html>
